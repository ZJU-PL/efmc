
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>efmc.smttools.mapped_blast &#8212; EFMC Documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">EFMC Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">efmc.smttools.mapped_blast</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for efmc.smttools.mapped_blast</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains functions for translating SMT2 formulas to CNF and DIMACS format.</span>

<span class="sd">It also keeps track of the mapping between bit-vector variables and their corresponding Boolean variables.</span>

<span class="sd">TODO: it seems that this file can be slow. We need to profile and optimize it.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">z3</span>


<span class="c1"># p cnf nvar nclauses</span>
<span class="c1"># cr projected_var_ids</span>


<div class="viewcode-block" id="is_literal"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.is_literal">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">is_literal</span><span class="p">(</span><span class="n">exp</span><span class="p">:</span> <span class="n">z3</span><span class="o">.</span><span class="n">ExprRef</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if an expression is a literal (uninterpreted constant).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_const</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exp</span><span class="o">.</span><span class="n">decl</span><span class="p">()</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">==</span> <span class="n">z3</span><span class="o">.</span><span class="n">Z3_OP_UNINTERPRETED</span></div>


<div class="viewcode-block" id="proj_id_last"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.proj_id_last">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">proj_id_last</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">n_proj_vars</span><span class="p">,</span> <span class="n">n_vars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a projected variable ID to the original variable ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        var: The projected variable ID to convert.</span>
<span class="sd">        n_proj_vars: The number of projected variables.</span>
<span class="sd">        n_vars: The total number of variables.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">var</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">is_neg</span> <span class="o">=</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n_proj_vars</span><span class="p">:</span>
        <span class="n">new_var</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_proj_vars</span> <span class="o">+</span> <span class="n">n_vars</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_var</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_proj_vars</span>

    <span class="k">return</span> <span class="n">new_var</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">is_neg</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="bitblast"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.bitblast">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">bitblast</span><span class="p">(</span><span class="n">formula</span><span class="p">:</span> <span class="n">z3</span><span class="o">.</span><span class="n">ExprRef</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bit-blast a formula to CNF.&quot;&quot;&quot;</span>
    <span class="n">input_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">collect_vars</span><span class="p">(</span><span class="n">formula</span><span class="p">))</span>  <span class="c1"># this might be slow?</span>
    <span class="c1"># input_vars = get_vars(formula)  # FIXME: get_vars is from z3, but it can be VERY slow...</span>
    <span class="c1"># map bits in the bv input vars</span>
    <span class="n">map_clauses</span><span class="p">,</span> <span class="n">map_vars</span><span class="p">,</span> <span class="n">bv2bool</span> <span class="o">=</span> <span class="n">map_bitvector</span><span class="p">(</span><span class="n">input_vars</span><span class="p">)</span>
    <span class="c1"># print(bv2bool)</span>
    <span class="n">id_table</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {varname: id}</span>

    <span class="n">curr_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">map_vars</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">decl</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="n">id_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_id</span>
        <span class="n">curr_id</span> <span class="o">=</span> <span class="n">curr_id</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># projection_scope = curr_id - 1</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Goal</span><span class="p">()</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">map_clauses</span><span class="p">)</span>  <span class="c1"># why adding these constraints?</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Then</span><span class="p">(</span><span class="s2">&quot;simplify&quot;</span><span class="p">,</span> <span class="s2">&quot;bit-blast&quot;</span><span class="p">,</span> <span class="s2">&quot;tseitin-cnf&quot;</span><span class="p">)</span>
    <span class="n">blasted</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="n">g</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">blasted</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">bv2bool</span></div>


<div class="viewcode-block" id="to_dimacs"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.to_dimacs">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">to_dimacs</span><span class="p">(</span><span class="n">cnf</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">proj_last</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate an SMT2 formula to a CNF.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cnf_clauses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">projection_scope</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">clause_expr</span> <span class="ow">in</span> <span class="n">cnf</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">z3</span><span class="o">.</span><span class="n">is_or</span><span class="p">(</span><span class="n">clause_expr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_not</span><span class="p">(</span><span class="n">clause_expr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">clause_expr</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">dimacs_clause</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dimacs_visitor</span><span class="p">(</span><span class="n">clause_expr</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="c1"># dimacs_clause.append(&#39;0&#39;) # TODO: why append 0???</span>
        <span class="n">cnf_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dimacs_clause</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">proj_last</span><span class="p">:</span>
        <span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">cnf_clauses</span><span class="p">:</span>
            <span class="n">int_clause</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clause</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">proj_clause</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">proj_id_last</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">projection_scope</span><span class="p">,</span> <span class="n">n_vars</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">int_clause</span>
            <span class="p">]</span>
            <span class="c1"># proj_clause.append(0)  # TODO: why append 0???</span>
            <span class="n">str_clause</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">proj_clause</span><span class="p">])</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str_clause</span><span class="p">)</span>

        <span class="n">cnf_clauses</span> <span class="o">=</span> <span class="n">clauses</span>
        <span class="n">cnf_header</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;p cnf </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cnf_clauses</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;cr </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">n_vars</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">projection_scope</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n_vars</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cnf_header</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;p cnf </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cnf_clauses</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;cr </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">projection_scope</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">cnf_header</span><span class="p">,</span> <span class="n">cnf_clauses</span></div>


<div class="viewcode-block" id="to_dimacs_numeric"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.to_dimacs_numeric">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">to_dimacs_numeric</span><span class="p">(</span><span class="n">cnf</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">proj_last</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate an SMT2 formula to numeric clauses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cnf_clauses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">projection_scope</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">clause_expr</span> <span class="ow">in</span> <span class="n">cnf</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">z3</span><span class="o">.</span><span class="n">is_or</span><span class="p">(</span><span class="n">clause_expr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_not</span><span class="p">(</span><span class="n">clause_expr</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">clause_expr</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">dimacs_clause_numeric</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dimacs_visitor_numeric</span><span class="p">(</span><span class="n">clause_expr</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="n">cnf_clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dimacs_clause_numeric</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">proj_last</span><span class="p">:</span>
        <span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">cnf_clauses</span><span class="p">:</span>
            <span class="n">int_clause</span> <span class="o">=</span> <span class="n">clause</span>
            <span class="n">proj_clause</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">proj_id_last</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">projection_scope</span><span class="p">,</span> <span class="n">n_vars</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">int_clause</span>
            <span class="p">]</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proj_clause</span><span class="p">)</span>
        <span class="n">cnf_clauses</span> <span class="o">=</span> <span class="n">clauses</span>
        <span class="n">cnf_header</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cnf_header</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cnf_header</span><span class="p">,</span> <span class="n">cnf_clauses</span></div>


<div class="viewcode-block" id="map_bitvector"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.map_bitvector">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">map_bitvector</span><span class="p">(</span><span class="n">input_vars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map bit-vector variables to their corresponding Boolean variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print(&quot;input vars...&quot;)</span>
    <span class="c1"># print(input_vars)</span>
    <span class="n">clauses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mapped_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bv2bool</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># for tracking what Bools corresponding to a bv</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">input_vars</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">decl</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">bool_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="n">extracted_bool</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># why adding this</span>
            <span class="n">clause</span> <span class="o">=</span> <span class="n">extracted_bool</span> <span class="o">==</span> <span class="p">(</span><span class="n">z3</span><span class="o">.</span><span class="n">Extract</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="o">==</span> <span class="n">z3</span><span class="o">.</span><span class="n">BitVecVal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">mapped_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_bool</span><span class="p">)</span>
            <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span>
            <span class="n">bool_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">bv2bool</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bool_vars</span>
    <span class="c1"># print(clauses)</span>
    <span class="k">return</span> <span class="n">clauses</span><span class="p">,</span> <span class="n">mapped_vars</span><span class="p">,</span> <span class="n">bv2bool</span></div>


<div class="viewcode-block" id="dimacs_visitor"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.dimacs_visitor">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">dimacs_visitor</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visit an SMT2 formula and return the DIMACS clauses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">decl</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">id_var</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">id_var</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_var</span>
        <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">id_var</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_not</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">children</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">children</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dimacs_visitor</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_or</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">yield from</span> <span class="n">dimacs_visitor</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="k">return</span>  <span class="c1"># correct?</span>
    <span class="c1"># elif is_false(e): return ??</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled type: </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="dimacs_visitor_numeric"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.dimacs_visitor_numeric">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">dimacs_visitor_numeric</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Visit an SMT2 formula and return numeric DIMACS clauses.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">decl</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">id_var</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">id_var</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_var</span>
        <span class="k">yield</span> <span class="n">id_var</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_not</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">children</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">children</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="o">-</span><span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dimacs_visitor_numeric</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_or</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">yield from</span> <span class="n">dimacs_visitor_numeric</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_true</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="k">return</span>  <span class="c1"># correct?</span>
    <span class="c1"># elif is_false(e): return ??</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled type: </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="collect_vars"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.collect_vars">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">collect_vars</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect all variables in an SMT2 formula.</span>
<span class="sd">    TODO: this can be slow?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">seen</span><span class="p">[</span><span class="n">exp</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># check if &#39;e&#39; is a bitvector input variable</span>
    <span class="k">if</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_bv</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">exp</span>
    <span class="k">elif</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_app</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">exp</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">yield from</span> <span class="n">collect_vars</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="n">z3</span><span class="o">.</span><span class="n">is_quantifier</span><span class="p">(</span><span class="n">exp</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">collect_vars</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">body</span><span class="p">(),</span> <span class="n">seen</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="translate_smt2formula_to_cnf"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.translate_smt2formula_to_cnf">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">translate_smt2formula_to_cnf</span><span class="p">(</span>
    <span class="n">formula</span><span class="p">:</span> <span class="n">z3</span><span class="o">.</span><span class="n">ExprRef</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate an SMT2 formula to a CNF.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">projection_last</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">projection_last</span> <span class="o">=</span> <span class="n">projection_last</span> <span class="ow">and</span> <span class="n">projection_last</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;false&quot;</span>
    <span class="c1"># print(&quot;Generating DIMACS with projection...&quot;)</span>
    <span class="n">blasted</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">bv2bool</span> <span class="o">=</span> <span class="n">bitblast</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
    <span class="c1"># FIXME: if formula is very simple, the &quot;simplify&quot; tactic may convert it to &quot;False&quot;,</span>
    <span class="c1">#   However it seems that cnf tactic needs &quot;simplify&quot; to perform some normalization</span>
    <span class="c1">#   Maybe we need to turn the parameters of &quot;simplify&quot;?</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">clauses</span> <span class="o">=</span> <span class="n">to_dimacs</span><span class="p">(</span><span class="n">blasted</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">projection_last</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bv2bool</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">clauses</span></div>


<div class="viewcode-block" id="translate_smt2formula_to_numeric_clauses"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.translate_smt2formula_to_numeric_clauses">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">translate_smt2formula_to_numeric_clauses</span><span class="p">(</span>
    <span class="n">formula</span><span class="p">:</span> <span class="n">z3</span><span class="o">.</span><span class="n">ExprRef</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate an SMT2 formula to numeric clauses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">projection_last</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">projection_last</span> <span class="o">=</span> <span class="n">projection_last</span> <span class="ow">and</span> <span class="n">projection_last</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;false&quot;</span>
    <span class="c1"># print(&quot;Generating DIMACS with projection...&quot;)</span>
    <span class="n">blasted</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">bv2bool</span> <span class="o">=</span> <span class="n">bitblast</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">clauses</span> <span class="o">=</span> <span class="n">to_dimacs_numeric</span><span class="p">(</span><span class="n">blasted</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">projection_last</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bv2bool</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">clauses</span></div>


<div class="viewcode-block" id="translate_smt2formula_to_cnf_file"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.translate_smt2formula_to_cnf_file">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">translate_smt2formula_to_cnf_file</span><span class="p">(</span><span class="n">formula</span><span class="p">:</span> <span class="n">z3</span><span class="o">.</span><span class="n">ExprRef</span><span class="p">,</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Translate an SMT2 formula to a CNF file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">projection_last</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">projection_last</span> <span class="o">=</span> <span class="n">projection_last</span> <span class="ow">and</span> <span class="n">projection_last</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;false&quot;</span>
    <span class="n">blasted</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">bv2bool</span> <span class="o">=</span> <span class="n">bitblast</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">clauses</span> <span class="o">=</span> <span class="n">to_dimacs</span><span class="p">(</span><span class="n">blasted</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">projection_last</span><span class="p">)</span>
    <span class="n">saved_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">file</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clauses</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">saved_stdout</span></div>


<span class="c1"># TODO: what is projection_last</span>
<div class="viewcode-block" id="test_blast"><a class="viewcode-back" href="../../../smttools.html#efmc.smttools.mapped_blast.test_blast">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">test_blast</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
    <span class="n">projection_last</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">projection_last</span> <span class="o">=</span> <span class="n">projection_last</span> <span class="ow">and</span> <span class="n">projection_last</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;false&quot;</span>

    <span class="n">formula_vec</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">parse_smt2_file</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="n">z3</span><span class="o">.</span><span class="n">And</span><span class="p">(</span><span class="n">formula_vec</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating DIMACS with projection...&quot;</span><span class="p">)</span>
    <span class="n">blasted</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">bitblast</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
    <span class="n">header</span><span class="p">,</span> <span class="n">clauses</span> <span class="o">=</span> <span class="n">to_dimacs</span><span class="p">(</span><span class="n">blasted</span><span class="p">,</span> <span class="n">id_table</span><span class="p">,</span> <span class="n">projection_last</span><span class="p">)</span>
    <span class="c1"># print(&#39;\n&#39;.join(header))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clauses</span><span class="p">))</span></div>
    <span class="c1"># print(id_table)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">EFMC Documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">efmc.smttools.mapped_blast</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2024, rainoftime.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.0.
    </div>
  </body>
</html>